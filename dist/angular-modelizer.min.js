"use strict";!function(e,t){"function"==typeof define&&define.amd?define(["angular"],function(e){return t(e,document)}):t(angular,document)}(window,function(e,t,r){var n,i=function(e){throw new Error(e)},s=0,o={};o.isString=function(t){return e.isString(t)},o.isNumber=function(t){return e.isNumber(t)},o.isObject=function(e){var t=typeof e;return"function"===t||e&&"object"===t||!1},o.isArray=function(t){return e.isArray(t)},o.isArguments=function(e){return"[object Arguments]"===Object.prototype.toString.call(e)},o.isFunction=function(t){return e.isFunction(t)},o.isEqual=function(t,r){return e.equals(t,r)},o.isEmpty=function(e){if(null===e||void 0===e)return!0;if(o.isArray(e)||o.isString(e)||o.isArguments(e))return 0===e.length;for(var t in e)if(o.has(e,t))return!1;return!0},o.extend=function(e){if(!o.isObject(e))return e;for(var t,r,n=1,i=arguments.length;i>n;n++){t=arguments[n];for(r in t)if(Object.prototype.hasOwnProperty.call(t,r)){var s=Object.getOwnPropertyDescriptor(e,r);s&&s.get&&!s.set||(e[r]=t[r])}}return e},o.has=function(e,t){return e&&Object.prototype.hasOwnProperty.call(e,t)},o.indexOf=function(e,t){if(!e||!e.length)return-1;for(var r=0;r<e.length;r++)if(e[r]===t)return r;return-1},o.keys=function(e){if(!o.isObject(e))return[];if(Object.keys)return Object.keys(e);var t=[];for(var r in e)o.has(e,r)&&t.push(r);return t},o.values=function(e){for(var t=o.keys(e),r=t.length,n=new Array(r),i=0;r>i;i++)n[i]=e[t[i]];return n},o.pairs=function(e){for(var t=o.keys(e),r=t.length,n=new Array(r),i=0;r>i;i++)n[i]=[t[i],e[t[i]]];return n},o.contains=function(e,t){return e?(e.length!==+e.length&&(e=o.values(e)),o.indexOf(e,t)>=0):!1},o.flatten=function(e,t,r,n){if(r=!!r,n=n||[],t&&o.isArray(e)&&e.length>0){for(var i=!0,s=0;s<e.length;s++)if(!o.isArray(e[s])){i=!1;break}if(i)return Array.prototype.concat.apply(n,e)}for(var l=0,a=e.length;a>l;l++){var u=e[l];o.isArray(u)||o.isArguments(u)?t?Array.prototype.push.apply(n,u):o.flatten(u,t,r,n):r||n.push(u)}return n},o.difference=function(e){var t=o.flatten(Array.prototype.slice.call(arguments,1),!0,!0,[]);return o.filter(e,function(e){return!o.contains(t,e)})},o.without=function(e){return o.difference(e,Array.prototype.slice.call(arguments,1))},o.map=function(e,t){return Array.prototype.map.call(e,t)},o.iteratee=function(t){if(!t)return e.identity;if(o.isFunction(t)){var r=t;return function(e,t,n){return r.call(null,e,t,n)}}if(o.isObject(t))return o.matches(t);var n=function(e){return function(t){return t[e]}};return n(t)},o.matches=function(e){var t=o.pairs(e),r=t.length;return function(e){if(!e)return!r;e=new Object(e);for(var n=0;r>n;n++){var i=t[n],s=i[0];if(i[1]!==e[s]||!(s in e))return!1}return!0}},o.any=function(e,t){if(!e)return!1;t=o.iteratee(t);var r,n,i=e.length!==+e.length&&o.keys(e),s=(i||e).length;for(r=0;s>r;r++)if(n=i?i[r]:r,t(e[n],n,e))return!0;return!1},o.find=function(e,t){var r;return t=o.iteratee(t),o.any(e,function(e,n,i){return t(e,n,i)?(r=e,!0):void 0}),r},o.filter=function(t,r){var n=[];return t?(r=o.iteratee(r),e.forEach(t,function(e,t,i){r(e,t,i)&&n.push(e)}),n):n},o.clone=function(e){return o.isObject(e)?o.isArray(e)?e.slice():o.extend({},e):e},o.uniqueId=function(e){var t=++s;return String(null===e?"":e)+t};var l=function(e,t,n){if(!o.isObject(t)||!o.isObject(e)||!n)return!1;var i=Object.getOwnPropertyDescriptor(t,n);if(i&&(i.get||i.set)){var s=i.get||r,l=i.set||r;return Object.defineProperty(e,n,{get:s,set:l,enumerable:!0,configurable:!0}),!0}return!1},a=function(e){if(!e)return{};if(!o.isObject(e))return e;for(var t=Array.prototype.slice.call(arguments,1),r=o.keys(e),n={},i=0;i<r.length;i++){var s=r[i];s in e&&!o.contains(t,s)&&(l(n,e,s)||(n[s]=e[s]))}return n},u=function(e,t){if(!e)return e;if(t&&o.isFunction(t)||(t=o.extend),o.isArray(e)){for(var r=o.clone(e),n=0;n<r.length;n++)r[n]=u(r[n]);return r}return o.isFunction(e)?e:o.isObject(e)?t({},e):e},c=function(t){return t=t||{},e.forEach(arguments,function(e){if(e!==t&&o.isObject(e))for(var r in e)l(t,e,r)||(t[r]=u(e[r],c))}),t},d={isLikeUrl:function(e){return o.contains(e,"/")||o.contains(e,"-")},asUrl:function(e){return e?d.stripDoubleSlashes("/"+e):""},combineUrls:function(){var e=o.filter(Array.prototype.slice.call(arguments),function(e){return!!e});return d.asUrl(e.join("/"))},stripDoubleSlashes:function(e){return e?e.replace(/(\/)\/+/g,"$1"):""},trimSlashes:function(e){return e.replace(/^\/|\/$/g,"")},stripOverlap:function(e,t){if(!e||!t)return e;var r=d.trimSlashes(e).split("/"),n=d.trimSlashes(t).split("/"),i=[],s=!1;for(r.length>n.length?r.splice(0,r.length-n.length):n.length=r.length;r.length;){for(var o=0;o<r.length;o++){if(r[o]!==n[o]){i=[],s=!1;break}s=!0,i.push(r[o])}if(s)break;r.shift(),n.pop()}var l=d.asUrl(i.join("/"));return d.asUrl(l.length?e.substring(0,e.indexOf(l)):e)},setUrlParams:function(e,t,n){return e?e.replace(/\:\_*[A-Za-z]+/g,function(s){return s=s.replace(/\:*/,""),t[s]!==r||n||i('No parameter "'+s+'" is available for URL '+e),t[s]}):e},appendIdParam:function(e,t,r){return e?e.replace(/([^\/])$/,"$1/")+(r?t:":"+(t||"id")):e},buildRestfulUrl:function(e,t,r){return t?d.asUrl(e):d.asUrl(d.appendIdParam(e,r,!0))}},f={capitalize:function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):e},pluralize:function(e){return e?"s"===e.charAt(e.length)?e+"es":e+"s":e},toDashCase:function(e){return e?e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase():e}},h={byModelName:{},byCollectionName:{},byBaseUrl:{},addModelClass:function(e){if(e&&e._modelClassMeta){var t=e._modelClassMeta;t.modelName&&(this.byModelName[t.modelName]=e),t.collectionName&&(this.byCollectionName[t.collectionName]=e),e.baseUrl&&"/"!==e&&!this.byBaseUrl[e.baseUrl]&&(this.byBaseUrl[e.baseUrl]=e)}}},m=function(e){return e&&o.isFunction(e.resourceUrl)?e.resourceUrl():""},p={model:function(e){var t,r=e.modelClass,i=a(e,"modelClass"),s=!r||o.isString(r);i.urlPrefix||i.urlPrefix===!1?o.isFunction(i.urlPrefix)&&(t=i.urlPrefix,delete i.urlPrefix):t=m;var l=function(l,a){var u,c=null;r&&s?u=h.byModelName[r]||h.byModelName[a]:r&&(u=r),u||(u=n),e.modelClass=u,Object.defineProperty(l,a,{enumerable:!0,configurable:!0,get:function(){return c&&t&&(c.urlPrefix=t(l)),c},set:function(e){return e?(e instanceof u?c=e:o.isObject(e)&&(c=u.$new(e,i)),void 0):(c=e,void 0)}})};return e.attrType="model",l.attrDefinition=e,l.isPropertyInitializer=!0,l},collection:function(e){var t,r=e.modelClass,i=a(e,"modelClass"),s=!r||o.isString(r);i.urlPrefix||i.urlPrefix===!1?o.isFunction(i.urlPrefix)&&(t=i.urlPrefix,delete i.urlPrefix):t=m;var l=function(o,l){var a,u=null;r&&s?a=h.byModelName[r]||h.byModelName[l]:r&&(a=r),a||(a=n),e.modelClass=a,Object.defineProperty(o,l,{enumerable:!0,configurable:!0,get:function(){return u||(u=a.$newCollection(null,i)),t&&(u.urlPrefix=t(o)),u},set:function(e){u?u.reset(e):u=a.$newCollection(e,i)}})};return e.attrType="collection",l.attrDefinition=e,l.isPropertyInitializer=!0,l},date:function(e){var t=function(e,t){var r=null;Object.defineProperty(e,t,{enumerable:!0,configurable:!0,get:function(){return r||(r=new Date(0)),r},set:function(e){e instanceof Date?r=e:(o.isString(e)||o.isNumber(e))&&(r=Date(e))}})};return e.attrType="date",t.attrDefinition=e,t.isPropertyInitializer=!0,t},computed:function(e){var t=function(t,r){Object.defineProperty(t,r,{enumerable:!0,configurable:!0,get:function(){return e.apply(this)}})};return t.attrDefinition={attrType:"computed"},t.isPropertyInitializer=!0,t}},b={isDefaultModelClass:function(e){return e===n},isModelClass:function(e){return e.prototype instanceof n||b.isDefaultModelClass(e)},hasSpecialAttr:function(e,t){return e&&e._modelClassMeta&&e._modelClassMeta.propertyInitializers?!!e._modelClassMeta.propertyInitializers[t]:!1},hasCollectionAttr:function(e,t){var r=this.getSpecialAttrMeta(e,t);return r&&"collection"===r.attrType},hasModelAttr:function(e,t){var r=this.getSpecialAttrMeta(e,t);return r&&"model"===r.attrType},getSpecialAttrMeta:function(e,t){return this.hasSpecialAttr(e,t)?e._modelClassMeta.propertyInitializers[t].attrDefinition:null},extendClass:function(e,t,r,n){var i;return n=n||"Extended",i=t&&o.has(t,"constructor")?t.constructor:new Function("p","return function "+n+"(){return p.apply(this,arguments);}")(e),c(i,e,r),i.prototype=Object.create(e.prototype),t&&c(i.prototype,t),i.superclass=i.prototype._superclass=e,i.__super__=i.prototype._super=e.prototype,i.prototype._class=i,i},extendModelClass:function(e,t,n){t=t||{};var s,l,u,m=a(t,"static","collection","baseUrl","urlPrefix"),p={},b=o.isObject(t.collection)?t.collection:null,v=o.isObject(t.static)?t.static:{},g={},y={};o.isArray(n)&&n.length>0?(s=n[0],l=n[1]):o.isString(n)&&(s=n),o.isString(s)||i("You have to provide the model name to define a new model"),h.byModelName[s]&&i('The model name should be unique. It seems that you already have the model with name "'+s+'"'),s&&!l&&(l=f.pluralize(s)),h.byCollectionName[l]&&i('The collection name should be unique. It seems that you already have the model with collection name "'+l+'"'),u=s?f.capitalize(s):"ExtendedModel";for(var C in m)if(o.isFunction(m[C]))m[C].isPropertyInitializer&&(g[C]=m[C],delete m[C]);else{var x=Object.getOwnPropertyDescriptor(m,C);if(x.get||x.set)continue;p[C]=m[C],delete m[C]}var _=c({},m);v.urlPrefix=t.urlPrefix||r,v.baseUrl=t.baseUrl||r,v.baseUrl||(v.baseUrl=d.asUrl(f.toDashCase(l)));var U=this.extendClass(e,_,v,u);return y={modelDefinition:t,modelName:s,collectionName:l,superclass:e,defaults:o.extend({},e._modelClassMeta&&e._modelClassMeta.defaults||{},p),propertyInitializers:o.extend({},e._modelClassMeta&&e._modelClassMeta.propertyInitializers||{},g),collectionExtensions:{}},e._modelClassMeta&&o.isObject(e._modelClassMeta.collectionExtensions)&&(y.collectionExtensions=o.extend({},y.collectionExtensions,e._modelClassMeta.collectionExtensions)),b&&(y.collectionExtensions=o.extend({},y.collectionExtensions,b)),U._modelClassMeta=U.prototype._modelClassMeta=y,U},extendCollection:function(e,t){return e&&e._modelClassMeta&&t?(e._modelClassMeta.collectionExtensions=o.extend({},e._modelClassMeta.collectionExtensions,t),e):e}},v={resolve:function(e){var t=e.parentModelized,i=e.isCollection,s=e.resourceName,l=t&&t.modelClass||r,a={modelClass:null,modelInstanceOptions:{},isCollection:i,resourceName:s,resourceId:e.resourceId||null};if(!d.isLikeUrl(e.resourceName)&&l&&b.isModelClass(l)&&!b.isDefaultModelClass(l)&&(i&&b.hasCollectionAttr(l,s)||b.hasModelAttr(l,s))){var u=b.getSpecialAttrMeta(l,s);if(u){var c=u.modelClass;c&&(b.isModelClass(c)?a.modelClass=c:o.isString(c)&&(a.modelClass=h.byModelName[c]||h.byCollectionName[c])),a.modelClass||(a.modelClass=n)}}if(!a.modelClass){var f=[],m=d.asUrl(s);f.unshift(m);for(var p=t;p&&(p.isCollection||!p.resourceId);){var v=p.modelInstanceOptions.baseUrl;v&&(m=d.combineUrls(v,m),f.unshift(m));var g=p.modelInstanceOptions.urlPrefix;if(!g)break;p=p.parentModelized,!p&&g&&f.unshift(d.combineUrls(g,m))}for(var y=0;y<f.length&&(a.modelClass=h.byBaseUrl[f[y]],!a.modelClass);y++);}a.modelClass||d.isLikeUrl(s)||(h.byModelName[s]&&(a.modelClass=h.byModelName[s]),i&&h.byCollectionName[s]&&(a.modelClass=h.byCollectionName[s])),a.modelClass||(a.modelClass=n),a.modelInstanceOptions.baseUrl=a.modelClass.baseUrl||d.asUrl(s);var C="";if(t){var x=t.modelInstanceOptions.baseUrl;!t.isCollection&&t.resourceId&&(x=d.buildRestfulUrl(x,!1,t.resourceId)),C=d.combineUrls(t.modelInstanceOptions.urlPrefix,x)}return C&&(a.modelInstanceOptions.urlPrefix=d.stripOverlap(C,a.modelInstanceOptions.baseUrl)),t&&(a.parentModelized=t),a},asModelized:function(e){if(!e)return null;var t=b.isModelClass(e);return t||o.isArray(e)&&e.isCollection?{modelClass:t?e:e.modelClass,modelInstanceOptions:{baseUrl:e.baseUrl,urlPrefix:e.urlPrefix},isCollection:e.isCollection}:e instanceof n?{modelClass:e._class,modelInstanceOptions:o.clone(e._initOptions),resourceId:e.idAttribute?e[e.idAttribute]:null}:null}},g=["$$hashKey","$iid","_modelClassMeta","_collections","_remoteState","_loadingTracker","_initOptions","idAttribute","baseUrl","urlPrefix","$modelErrors","$error","$valid","$invalid","$loading","$selected","$destroyed"],y=function(t){return t=t||{},e.forEach(arguments,function(e){if(e!==t&&o.isObject(e))for(var i in e){var s=Object.getOwnPropertyDescriptor(e,i);if(s&&(s.get||s.set)){var l=s.get||r,a=s.set||r;Object.defineProperty(t,i,{get:l,set:a,enumerable:!0,configurable:!0})}else t[i]=e[i]&&o.isObject(e[i])&&(e[i]instanceof n||e[i].$isCollection)?e[i]:u(e[i],y)}}),t},C=function(e){if(e._modelClassMeta&&e._modelClassMeta.propertyInitializers)for(var t=Object.getOwnPropertyNames(e._modelClassMeta.propertyInitializers),r=0;r<t.length;r++){var n=t[r],i=e._modelClassMeta.propertyInitializers[n];i(e,n)}};return e.module("angular-modelizer",[]).provider("modelize",function(){var t=this;this.parseModelErrors=function(e){if(!e||!e.fieldErrors||!o.isArray(e.fieldErrors))return null;var t={};return e.fieldErrors.forEach(function(e){var r=e.field,n=e.message;o.isArray(t[r])||(t[r]=[]),t[r].push(n)}),t},this.$get=["$q","$http",function(s,l){var a=function(){if(!(this instanceof a))return new a;var e=this,t=[];this.active=function(){return t.length>0},this.destroy=this.cancel=function(){for(var e=t.length-1;e>=0;e--)t[e].resolve();t.length=0},this.createPromise=function(){var e=s.defer();return t.push(e),e.promise.finally(function(){t.splice(t.indexOf(e),1)}),e},this.addPromise=function(t){if(!t.then)throw new Error("promiseTracker#addPromise expects a promise object!");var r=e.createPromise();return t.then(function(e){return r.resolve(e),e},function(e){return r.reject(e),s.reject(e)}),r}},u={setFuture:function(e,t){return e.$future=t,e}},f=function(e){e=e||{};var t=e.method||"",n=e.url,i=e.data||r,a=!!e.fullResponse,c=!!e.future,d=s.defer(),f={};return l(o.extend({},e,{method:t.toUpperCase(),url:n,data:i})).then(function(e){c&&o.extend(f,e.data),d.resolve(a?e:e.data)},function(e){d.reject(e)}),c&&(d.promise=u.setFuture(d.promise,f)),d.promise};o.extend(f,{setUrlParams:d.setUrlParams,get:function(e,t){return f(o.extend({},t,{method:"GET",url:e}))},post:function(e,t,r){return f(o.extend({},r,{method:"POST",url:e,data:t}))},put:function(e,t,r){return f(o.extend({},r,{method:"PUT",url:e,data:t}))},patch:function(e,t,r){return f(o.extend({},r,{method:"PATCH",url:e,data:t}))},"delete":function(e,t){return f(o.extend({},t,{method:"DELETE",url:e}))},head:function(e,t){return f(o.extend({},t,{method:"HEAD",url:e}))}});var m,x,_,U=function(e,t,r,n,i){i=i?o.clone(i):{},this.resourceName=e,this.resourceId=t,this.isCollection=r,this.parentModelized=n,this.modelized=v.resolve(this,i),o.extend(this,r?x:m)},O={one:function(e,t,r){return new U(e,t,!1,this.modelized,r)},many:function(e,t){return new U(e,null,!0,this.modelized,t)}},M={get $modelClass(){return this.modelized.modelClass},$new:function(e,t){return e=e||{},!this.isCollection&&this.resourceId&&(e[this.modelized.modelClass.prototype.idAttribute]=this.resourceId),this.modelized.modelClass.$new(e,o.extend({},this.modelized.modelInstanceOptions,t))},$newCollection:function(e,t){return this.modelized.modelClass.$newCollection(e,o.extend({},this.modelized.modelInstanceOptions,t))},resourceUrl:function(){var e,t=this.modelized.modelInstanceOptions||{};return o.isFunction(this.modelized.modelClass.resourceUrl)?this.modelized.modelClass.resourceUrl(t):t.baseUrl?(e=d.buildRestfulUrl(t.baseUrl,this.isCollection,this.resourceId),e?d.combineUrls(t.urlPrefix,e):null):null}};c(U.prototype,O,M),m={get:function(e){return e=e||{},e.updateRemoteState!==!1&&(e.updateRemoteState=!0),this.$new({},o.extend({},this.modelized.modelInstanceOptions,e)).fetch(e)},save:function(e,t){return t=t||{},t.updateRemoteState!==!1&&(t.updateRemoteState=!0),this.$new(e,o.extend({},this.modelized.modelInstanceOptions,t)).save(t)},destroy:function(e){return this.$new({},o.extend({},this.modelized.modelInstanceOptions,e)).$destroy(e)}},x={get:function(e,t){return this.modelized.modelClass.get(e,o.extend({},this.modelized.modelInstanceOptions,t))},all:function(e){return this.modelized.modelClass.all(o.extend({},this.modelized.modelInstanceOptions,e))},query:function(e,t){return this.modelized.modelClass.query(e,o.extend({},this.modelized.modelInstanceOptions,t))},create:function(e,t){if(!e&&!o.isObject(e))return s.reject(!1);t=t?o.clone(t):{},t.updateRemoteState!==!1&&(t.updateRemoteState=!0),e instanceof n||(e=this.modelized.modelClass.$new(e,o.extend({},this.modelized.modelInstanceOptions,t)));var r=e.save(null,t);return u.setFuture(r,e)},destroy:function(e,t){t=t?o.clone(t):{};var r=t.url;return this.modelized.modelClass.baseUrl&&(r=d.setUrlParams(d.appendIdParam(this.modelized.modelClass.baseUrl,e,!0),{})),r||i('URL error: "baseUrl" should be defined on "modelized" model class or "options.url" provided to "destroy" the model'),this.$request.delete(r,t).then(function(){return!0})}},_={one:function(e,t,r){return new U(e,t,!1,v.asModelized(this),r)},many:function(e,t){return new U(e,null,!0,v.asModelized(this),t)}};var P=function(e,t){var r=e||{};t=t?o.clone(t):{},this._initOptions=t,this.$iid=o.uniqueId("model_"),t.parse&&(r=this.parse(r,t)||{}),r=y({},this._modelClassMeta&&this._modelClassMeta.defaults||{},r),this.baseUrl=t.baseUrl||this.baseUrl||this._class.baseUrl,this.urlPrefix=t.urlPrefix||this.urlPrefix||this._class.urlPrefix,this.idAttribute&&r[this.idAttribute]&&(this[this.idAttribute]=r[this.idAttribute]),C(this),this.set(r),this._collections={},this._remoteState=null,this.$modelErrors=null,this._loadingTracker=new a,this.initialize.apply(this,arguments),t.updateRemoteState&&this._setRemoteState()};c(P.prototype,{_class:P,get $valid(){return this.isValid()},get $invalid(){return!this.isValid()},get $loading(){return this._loadingTracker&&this._loadingTracker.active()},idAttribute:"id",initialize:function(){},resourceUrl:function(){return this.baseUrl?!this.idAttribute||this.isNew()?d.setUrlParams(d.combineUrls(this.urlPrefix,this.baseUrl),this):d.setUrlParams(d.combineUrls(this.urlPrefix,d.appendIdParam(this.baseUrl,this.idAttribute)),this):null},set:function(e,t){return e=e?e instanceof P?e.getAttributes():o.clone(e):{},t=t||{},o.extend(this,e),t.updateRemoteState&&this._setRemoteState(),this},clear:function(e){for(var t in this.getAttributes(e))this[t]=r},fetch:function(e){if(this.$destroyed)return u.setFuture(s.reject(this),this);var t=this,n=this.resourceUrl();e=e?o.clone(e):{},e.parse===r&&(e.parse=!0);var l=!!e.fullResponse,a=!!e.rawData;n||i('URL error: "baseUrl" should be defined or "options.url" specified to "fetch" the model');var c=this.$request.get(n,o.extend({},e,{fullResponse:!0})).then(function(r){var n=e.parse?t.parse(r.data,e):r.data;return t.set(n,e),t._setRemoteState(null,e),o.isFunction(e.onSuccess)&&e.onSuccess.call(t,r),l?r:a?r.data:t},function(r){return o.isFunction(e.onError)&&e.onError.call(t,r),s.reject(r)});return this._loadingTracker&&this._loadingTracker.addPromise(c),u.setFuture(c,this)},save:function(e){if(this.$destroyed)return u.setFuture(s.reject(this),this);e=o.extend({},e);var t,r=this,n=this.isNew()?"post":e.patch?"patch":"put";if(e.url)t=e.url;else switch(n){case"post":t=this.baseUrl?d.combineUrls(this.urlPrefix,this.baseUrl):null,t||i('URL error: "baseUrl" should be defined or "options.url" specified to "save:create"');break;case"patch":case"put":t=this.resourceUrl(),t||i('URL error: "baseUrl" should be defined or "options.url" specified to "save:update"')}var l=o.extend({method:n,url:t},e);l.data="patch"===n?this.serialize({changedOnly:!0}):this.serialize(),this.transformOnSave&&o.isFunction(this.transformOnSave)&&(l.data=this.transformOnSave(l.data,e));var a=this.$request(l).then(function(t){if(t&&o.isObject(t)){var n=r.parse(t,e);r.set(n)}return r._setRemoteState(null,e),r}).catch(function(e){return 422===e.status&&e.data&&r.parseModelErrors&&(r.clearModelErrors(),r.addModelErrors(r.parseModelErrors(e.data))),s.reject(e)});return this._loadingTracker&&this._loadingTracker.addPromise(a),u.setFuture(a,this)},destroy:function(e){if(this.$destroyed)return u.setFuture(s.reject(this),this);e=e?o.clone(e):{};var t=this,r=function(){if(t._collections)for(var e in t._collections)t._collections[e].remove(t),delete t._collections[e];t._collections=null};if(this.isNew())return e.keepInCollections||r(),s.when(!1);e.wait||e.keepInCollections||r();var n=e.url||this.resourceUrl();n||i('URL error: "baseUrl" should be defined or "options.url" specified to "destroy" the model');var l=this.$request.delete(n,e).then(function(){return e.wait&&!e.keepInCollections&&r(),t.$destroyed=!0,t});return this._loadingTracker&&this._loadingTracker.addPromise(l),u.setFuture(l,this)},getAttributes:function(e){var t=this,r={},n=o.difference(Object.getOwnPropertyNames(t),g);e=e||{};for(var i=0;i<n.length;i++){var s=Object.getOwnPropertyDescriptor(t,n[i]);s&&(s.get&&!s.set&&!e.includeComputed||s.set&&!s.get)||(r[n[i]]=t[n[i]])}return r},serialize:function(e){e=e||{};var t=e.changedOnly?this.getChangedAttributes(e):this.getAttributes(e);for(var r in t){var n=t[r];n&&(n instanceof P||n.$isCollection)&&n.serialize&&(t[r]=n.serialize(o.extend({},e,{changedOnly:!1})))}return t},toJSON:function(t){return e.toJson(this.serialize(t))},parse:function(e){return e},parseModelErrors:function(e,r){return t.parseModelErrors(e,r)},clone:function(e){return this._class.$new(this.getAttributes(e),o.extend({},this._initOptions,e))},diff:function(e,t){var r={},n=this.getAttributes(t);for(var i in e){var s=e[i],l=n[i]instanceof P,a=l&&n[i].idAttribute,u=n[i]&&n[i].$isCollection,c=!1;if(l)s&&n[i][a]===s[a]||(c=!0);else if(u)if(s&&s.length===n[i].length){for(var d,f=n[i],h=0;h<f.length;h++)if(d=f[h]&&f[h].idAttribute||"id",s[h][d]!==f[h][d]){c=!0;break}}else c=!0;else o.isEqual(n[i],s)||(c=!0);c&&(r[i]={currentValue:n[i],comparedValue:s})}return r},getChangedAttributes:function(){var e={};if(this._remoteState){var t=this.diff(this._remoteState);for(var r in t)e[r]=t[r].currentValue}return e},isNew:function(){return!this.idAttribute||!this[this.idAttribute]},isValid:function(){return!this.$modelErrors},addModelError:function(e,t){if(e&&t&&(o.isString(t)||o.isArray(t))){var r=o.isArray(t)?t:[t];this.$modelErrors||(this.$modelErrors={}),this.$modelErrors[e]&&o.isArray(this.$modelErrors[e])?this.$modelErrors.concat(r):this.$modelErrors[e]=r}},clearModelError:function(e,t){t=t||{},e&&this.$modelErrors[e]&&(t.firstOnly&&o.isArray(this.$modelErrors[e])&&this.$modelErrors[e].length>1?this.$modelErrors[e].shift():delete this.$modelErrors[e])},addModelErrors:function(e){if(e)for(var t in e)this.$modelErrors||(this.$modelErrors={}),this.$modelErrors[t]=e[t]},clearModelErrors:function(){this.$modelErrors=null},_setRemoteState:function(e,t){e||e===!1||(e=this.serialize(t)),this._remoteState=e}}),c(P.prototype,_);var $={$request:f,get $loading(){return this._loadingTracker&&this._loadingTracker.active()},initialize:function(){},resourceUrl:function(){var e=this.baseUrl||this.modelClass&&this.modelClass.baseUrl||null;if(!e)return null;var t=this.urlPrefix||this.modelClass&&this.modelClass.urlPrefix||null;return d.setUrlParams(d.combineUrls(t,e),this)},fetch:function(e){var t=this;e=e?o.clone(e):{},e.parse===r&&(e.parse=!0);var n=!!e.fullResponse,l=!!e.rawData,a=e.url||this.resourceUrl();a||i('URL error: "baseUrl" should be defined or "options.url" specified to "fetch" the collection');var c=this.$request.get(a,o.extend({},e,{fullResponse:!0})).then(function(r){var i=e.reset?"reset":"set",s=e.parse&&t.parse?t.parse(r.data,e):r.data;return t[i](s,e),o.isFunction(e.onSuccess)&&e.onSuccess.call(t,r),n?r:l?r.data:t},function(r){return o.isFunction(e.onError)&&e.onError.call(t,r),s.reject(r)});return this._loadingTracker&&this._loadingTracker.addPromise(c),u.setFuture(c,this)},get:function(e){if(!e)return r;var t=this._modelId(e);return this._idsIndex[e]||this._idsIndex[t]||this._idsIndex[e.$iid]||r},where:function(e,t){if(o.isEmpty(e))return t?r:[];var n=t?"find":"filter";return o[n](this.models,function(t){for(var r in e)if(e[r]!==t[r])return!1;return!0})},any:function(e){return e?this.where(e).length>0:this.models.length>0},filter:function(e){return o.filter(this.models,e)},create:function(e,t){if(t=t?o.clone(t):{},t.updateRemoteState=!0,!(e=this._prepareModel(e,t)))return s.reject(!1);t.wait||this.add(e,t);var r=this,n=e.save(null,t);return n.then(function(){t.wait&&r.add(e,t)}),u.setFuture(n,this)},add:function(e,t){return this.set(e,o.extend({merge:!1},t,{add:!0,remove:!1}))},remove:function(e,t){var r=!o.isArray(e);t=t||{},e=r?[e]:o.clone(e);for(var n=0,i=e.length;i>n;n++){var s=e[n]=this.get(e[n]);if(s){var l=this._modelId(s);null!==l&&delete this._idsIndex[l],delete this._idsIndex[s.$iid];var a=o.indexOf(this.models,s);this.models.splice(a,1),this._removeModelReference(s,t)}}return r?e[0]:e},push:function(e,t){return this.add(e,o.extend({at:this.length},t))},pop:function(e){var t=this.models[this.length-1];return this.remove(t,e),t},unshift:function(e,t){return this.add(e,o.extend({at:0},t))},shift:function(e){var t=this.models[0];return this.remove(t,e),t},slice:function(){return Array.prototype.slice.apply(this.models,arguments)},set:function(e,t){if(t=o.extend({},{add:!0,remove:!0,merge:!0},t),t.parse&&(e=this.parse(e,t)),t.updateRemoteState!==!1&&(t.updateRemoteState=!0),!o.isArray(e)&&!o.isObject(e))return e;var r=!o.isArray(e);e=r?e?[e]:[]:e.slice();var n,i,s,l,a,u,c=t.add,d=t.merge,f=t.remove,h=t.at,m=[],p=[],b={};for(a=0,u=e.length;u>a;a++)if(n=e[a],o.isObject(n)){if(l=this.get(n))f&&(b[l.$iid]=!0),d&&n!==l&&(n=this._isModel(n)?n.getAttributes():n,t.parse&&(n=l.parse(n,t)),l.set(n,t)),e[a]=l;else if(c){if(i=e[a]=this._prepareModel(n,t),!i)continue;m.push(i),this._addModelReference(i,t)}i=l||i,i&&(s=this._modelId(i),b[s]=!0)}if(f){for(a=0,u=this.models.length;u>a;a++)b[(i=this.models[a]).$iid]||p.push(i);p.length&&this.remove(p,t)}if(m.length)for(h||(h=0),a=0,u=m.length;u>a;a++)this.models.splice(h+a,0,m[a]);return r?e[0]:e},reset:function(e,t){t=t||{};for(var r=0,n=this.models.length;n>r;r++)this._removeModelReference(this.models[r],t);return this._reset(),e&&e.length&&this.add(e,t),this},_reset:function(){this.models.length=0,this._idsIndex={}},_prepareModel:function(e,t){return this._isModel(e)?e:(t=t?o.clone(t):{},this.baseUrl&&(t.baseUrl=this.baseUrl),this.urlPrefix&&(t.urlPrefix=this.urlPrefix),new this.modelClass(e,t))},_isModel:function(e){return e instanceof P},_modelId:function(e){return e[this.modelClass.prototype.idAttribute||"id"]},_addModelReference:function(e){if(this._isModel(e)&&e.$iid){this._idsIndex[e.$iid]=e;var t=this._modelId(e);t&&(this._idsIndex[t]=e),e._collections=e._collections||{},e._collections[this.$iid]=this}},_removeModelReference:function(e){if(this._isModel(e)){delete this._idsIndex[e.$iid];var t=this._modelId(e);t&&delete this._idsIndex[t],e._collections&&e._collections[this.$iid]&&delete e._collections[this.$iid]}},serialize:function(e){return o.map(this.models,function(t){return t.serialize(e)})},toJSON:function(t){return e.toJson(this.serialize(t))},parse:function(e){return e},clone:function(e){return e=e||{},e.baseUrl||(e.baseUrl=this.baseUrl),e.urlPrefix||(e.urlPrefix=this.urlPrefix),this.modelClass.$newCollection(this.models,e)}};c($,_);var A=function(e,t){t=t||{};var i=t.modelClass||n,s=[];return c(s,$),i._modelClassMeta&&o.isObject(i._modelClassMeta.collectionExtensions)&&o.extend(s,i._modelClassMeta.collectionExtensions),s.$iid=o.uniqueId("collection_"),s.modelClass=i,s.$isCollection=!0,s._loadingTracker=new a,s.baseUrl=t.baseUrl||s.modelClass&&s.modelClass.baseUrl||r,s.urlPrefix=t.urlPrefix||s.modelClass&&s.modelClass.urlPrefix||r,s.models=s,s._reset(),s.initialize.apply(s,arguments),e&&s.reset(e,t),s};o.extend(P,{extend:function(e,t){o.isObject(e)&&!o.isArray(e)&&(t=e,e=null);var r=b.extendModelClass(this,t,e);return h.addModelClass(r),r},extendCollection:function(e){return b.extendCollection(this,e)},$new:function(e,t){return t=t?o.clone(t):{},new this(e,t)},$newCollection:function(e,t){return t=t?o.clone(t):{},t=o.extend({},{modelClass:this},t),A(e,t)},get:function(e,t){t=t||{},t.updateRemoteState!==!1&&(t.updateRemoteState=!0);var r=this,n=t.url,l=!!t.fullResponse,a=!!t.rawData;if(!n){var c=t.baseUrl||this.baseUrl,f=t.urlPrefix||this.urlPrefix;c&&(n=d.combineUrls(f,d.appendIdParam(c,e,!0)))}n||i('URL error: "baseUrl" should be defined or "options.url" specified to "get" a resource');var h=a?{}:r.$new({},t),m=this.$request.get(n,o.extend({},t,{fullResponse:!0})).then(function(e){return a?o.extend(h,e.data):h.set(e.data,t),o.isFunction(t.onSuccess)&&t.onSuccess.call(r,e),l?e:h},function(e){return o.isFunction(t.onError)&&t.onError.call(r,e),s.reject(e)});return h._loadingTracker&&h._loadingTracker.addPromise(m),u.setFuture(m,h)},query:function(e,t){t=t||{},t.params=e||{},t.updateRemoteState!==!1&&(t.updateRemoteState=!0);var r=this,n=t.url||d.combineUrls(t.urlPrefix,t.baseUrl)||d.combineUrls(this.urlPrefix,this.baseUrl),l=!!t.fullResponse,a=!!t.rawData;n||i('URL error: "baseUrl" should be defined or "options.url" specified to "query" a resource');var c=a?[]:r.$newCollection([],t),f=this.$request.get(n,o.extend({},t,{fullResponse:!0})).then(function(e){return a?Array.prototype.push.apply(c,e.data):c.reset(e.data,t),o.isFunction(t.onSuccess)&&t.onSuccess.call(r,e),l?e:c},function(e){return o.isFunction(t.onError)&&t.onError.call(r,e),s.reject(e)});return c._loadingTracker&&c._loadingTracker.addPromise(f),u.setFuture(f,c)},all:function(e){return e=e||{},e.updateRemoteState!==!1&&(e.updateRemoteState=!0),this.query(null,e)}}),n=P,P.$request=P.prototype.$request=f,c(P,_);var E=function(e,t){return O.many(e,t)};return c(E,O),E.attr=p,E.Model=n,E.$request=f,E.urlHelper=d,E.internal={modelizeMetaResolver:v,modelClassCache:h},E.defineModel=function(e,t){return n.extend(e,t)},E}]}).directive("mzModelError",function(){return{restrict:"A",require:["?ngModel"],link:function(e,t,r,n){var i=n[0];if(i){var s=r.modelError;if(!s&&o.isString(r.ngModel)){var l=r.ngModel.split(".");l.length>=2&&(l.splice(l.length-1,0,"$modelErrors"),s=l.join("."))}s&&e.$watch(s,function(e){var t=e||o.isArray(e)&&e.length>0;i.$setValidity("modelError",!t)})}}}})});