"use strict";!function(e,t){"function"==typeof define&&define.amd?define(["angular","lodash"],function(e,r){return t(e,r,document)}):t(angular,_,document)}(window,function(e,t,r,i){var s,n=function(e){throw new Error(e)},o=function(r){return r=r||{},e.forEach(arguments,function(e){if(e!==r&&t.isObject(e))for(var s in e){var n=Object.getOwnPropertyDescriptor(e,s);if(n&&(n.get||n.set)){var l=n.get||i,a=n.set||i;Object.defineProperty(r,s,{get:l,set:a,enumerable:!0,configurable:!0})}else r[s]=!t.isObject(e[s])||t.isFunction(e[s])?e[s]:t.isArray(e[s])?t.cloneDeep(e[s]):o({},e[s])}}),r},l=function(e){if(!e||!t.isObject(e))return!0;for(var r in e)if(e.hasOwnProperty(r))return!1;return!0},a={isLikeUrl:function(e){return t.contains(e,"/")||t.contains(e,"-")},asUrl:function(e){return e?a.stripDoubleSlashes("/"+e):""},combineUrls:function(){var e=t.filter(Array.prototype.slice.call(arguments),function(e){return!!e});return a.asUrl(e.join("/"))},stripDoubleSlashes:function(e){return e?e.replace(/(\/)\/+/g,"$1"):""},trimSlashes:function(e){return e.replace(/^\/|\/$/g,"")},stripOverlap:function(e,t){if(!e||!t)return e;var r=a.trimSlashes(e).split("/"),i=a.trimSlashes(t).split("/"),s=[],n=!1;for(r.length>i.length?r.splice(0,r.length-i.length):i.length=r.length;r.length;){for(var o=0;o<r.length;o++){if(r[o]!==i[o]){s=[],n=!1;break}n=!0,s.push(r[o])}if(n)break;r.shift(),i.pop()}var l=a.asUrl(s.join("/"));return a.asUrl(l.length?e.substring(0,e.indexOf(l)):e)},setUrlParams:function(e,t,r){return e?e.replace(/\:\_*[A-Za-z]+/g,function(s){return s=s.replace(/\:*/,""),t[s]!==i||r||n('No parameter "'+s+'" is available for URL '+e),t[s]}):e},appendIdParam:function(e,t,r){return e?e.replace(/([^\/])$/,"$1/")+(r?t:":"+(t||"id")):e},buildRestfulUrl:function(e,t,r){return t?a.asUrl(e):a.asUrl(a.appendIdParam(e,r,!0))}},d={capitalize:function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):e},pluralize:function(e){return e?"s"===e.charAt(e.length)?e+"es":e+"s":e},toDashCase:function(e){return e?e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase():e}},u={byModelName:{},byCollectionName:{},byBaseUrl:{},addModelClass:function(e){if(e&&e._modelClassMeta){var t=e._modelClassMeta;t.modelName&&(this.byModelName[t.modelName]=e),t.collectionName&&(this.byCollectionName[t.collectionName]=e),e.baseUrl&&"/"!==e&&!this.byBaseUrl[e.baseUrl]&&(this.byBaseUrl[e.baseUrl]=e)}}},c={model:function(e){var r=e.modelClass,i=t.omit(e,"modelClass"),n=!r||t.isString(r),o=function(o,l){var a,d=null;r&&n?a=u.byModelName[r]||u.byModelName[l]:r&&(a=r),a||(a=s),e.modelClass=a,Object.defineProperty(o,l,{enumerable:!0,configurable:!0,get:function(){return d},set:function(e){return e?(e instanceof a?d=e:t.isObject(e)&&(d=a.$new(e,i)),void 0):(d=e,void 0)}})};return e.attrType="model",o.attrDefinition=e,o.isPropertyInitializer=!0,o},collection:function(e){var r=e.modelClass,i=t.omit(e,"modelClass"),n=!r||t.isString(r),o=function(t,o){var l,a=null;r&&n?l=u.byModelName[r]||u.byModelName[o]:r&&(l=r),l||(l=s),e.modelClass=l,Object.defineProperty(t,o,{enumerable:!0,configurable:!0,get:function(){return a||(a=l.$newCollection(null,i)),a},set:function(e){a?a.reset(e):a=l.$newCollection(e,i)}})};return e.attrType="collection",o.attrDefinition=e,o.isPropertyInitializer=!0,o},date:function(e){var r=function(e,r){var i=null;Object.defineProperty(e,r,{enumerable:!0,configurable:!0,get:function(){return i||(i=new Date(0)),i},set:function(e){e instanceof Date?i=e:(t.isString(e)||t.isNumber(e))&&(i=Date(e))}})};return e.attrType="date",r.attrDefinition=e,r.isPropertyInitializer=!0,r},computed:function(e){var t=function(t,r){Object.defineProperty(t,r,{enumerable:!0,configurable:!0,get:function(){return e(this)}})};return t.attrDefinition={attrType:"computed"},t.isPropertyInitializer=!0,t}},h={isModelClass:function(e){return e.prototype instanceof s},isDefaultModelClass:function(e){return e===s},hasSpecialAttr:function(e,t){return e&&e._modelClassMeta&&e._modelClassMeta.propertyInitializers?!!e._modelClassMeta.propertyInitializers[t]:!1},hasCollectionAttr:function(e,t){var r=this.getSpecialAttrMeta(e,t);return r&&"collection"===r.attrType},hasModelAttr:function(e,t){var r=this.getSpecialAttrMeta(e,t);return r&&"model"===r.attrType},getSpecialAttrMeta:function(e,t){return this.hasSpecialAttr(e,t)?e._modelClassMeta.propertyInitializers[t].attrDefinition:null},extendClass:function(e,r,i,s){var n;return s=s||"Extended",n=r&&t.has(r,"constructor")?r.constructor:new Function("p","return function "+s+"(){return p.apply(this,arguments);}")(e),o(n,e,i),n.prototype=Object.create(e.prototype),r&&o(n.prototype,r),n.superclass=n.prototype._superclass=e,n.__super__=n.prototype._super=e.prototype,n.prototype._class=n,n},extendModelClass:function(e,r,s){r=r||{};var l,c,h,f=t.omit(r,"static","collection","baseUrl","urlPrefix"),m={},p=t.isObject(r.collection)?r.collection:null,v=t.isObject(r.static)?r.static:{},b={},g={};t.isArray(s)&&s.length>0?(l=s[0],c=s[1]):t.isString(s)&&(l=s),t.isString(l)||n("You have to provide the model name to define a new model"),u.byModelName[l]&&n('The model name should be unique. It seems that you already have the model with name "'+l+'"'),l&&!c&&(c=d.pluralize(l)),u.byCollectionName[c]&&n('The collection name should be unique. It seems that you already have the model with collection name "'+c+'"'),h=l?d.capitalize(l):"ExtendedModel";for(var y in f)if(t.isFunction(f[y]))f[y].isPropertyInitializer&&(b[y]=f[y],delete f[y]);else{var C=Object.getOwnPropertyDescriptor(f,y);if(C.get||C.set)continue;m[y]=f[y],delete f[y]}var _=o({},f);v.urlPrefix=r.urlPrefix||i,v.baseUrl=r.baseUrl||i,v.baseUrl||(v.baseUrl=a.asUrl(d.toDashCase(c)));var U=this.extendClass(e,_,v,h);return g={modelDefinition:r,modelName:l,collectionName:c,superclass:e,defaults:t.extend({},e._modelClassMeta&&e._modelClassMeta.defaults||{},m),propertyInitializers:t.extend({},e._modelClassMeta&&e._modelClassMeta.propertyInitializers||{},b),collectionExtensions:{}},e._modelClassMeta&&t.isObject(e._modelClassMeta.collectionExtensions)&&(g.collectionExtensions=t.extend({},g.collectionExtensions,e._modelClassMeta.collectionExtensions)),p&&(g.collectionExtensions=t.extend({},g.collectionExtensions,p)),U._modelClassMeta=U.prototype._modelClassMeta=g,U},extendCollection:function(e,r){return e&&e._modelClassMeta&&r?(e._modelClassMeta.collectionExtensions=t.extend({},e._modelClassMeta.collectionExtensions,r),e):e}},f={resolve:function(e){var t=e.parentModelized,r=e.isCollection,n=e.resourceName,o=t?t.modelClass:i,l={modelClass:null,modelInstanceOptions:{}};if(!a.isLikeUrl(e.resourceName)&&o&&h.isModelClass(o)&&o!==s&&(r&&h.hasCollectionAttr(o,n)||h.hasModelAttr()(o,n))){var d=h.getSpecialAttrMeta(o,n);d&&(l.modelClass=d.modelClass)}if(!l.modelClass){var c=[],f=a.asUrl(n);c.unshift(f);for(var m=t;m&&(m.isCollection||!m.resourceId);){var p=m.modelInstanceOptions.baseUrl;p&&(f=a.combineUrls(p,f),c.unshift(f));var v=m.modelInstanceOptions.urlPrefix;if(!v)break;m=m.parentModelized,!m&&v&&c.unshift(a.combineUrls(v,f))}for(var b=0;b<c.length&&(l.modelClass=u.byBaseUrl[c[b]],!l.modelClass);b++);}l.modelClass||a.isLikeUrl(n)||(u.byModelName[n]&&(l.modelClass=u.byModelName[n]),r&&u.byCollectionName[n]&&(l.modelClass=u.byCollectionName[n])),l.modelClass||(l.modelClass=s),l.modelInstanceOptions.baseUrl=l.modelClass.baseUrl||a.asUrl(n);var g="";if(t){var y=t.modelInstanceOptions.baseUrl;!t.isCollection&&t.resourceId&&(y=a.buildRestfulUrl(y,!1,t.resourceId)),g=a.combineUrls(t.modelInstanceOptions.urlPrefix,y)}return g&&(l.modelInstanceOptions.urlPrefix=a.stripOverlap(g,l.modelInstanceOptions.baseUrl)),t&&(l.parentModelized=t),l}},m=function(e){if(e._modelClassMeta&&e._modelClassMeta.propertyInitializers)for(var t=Object.getOwnPropertyNames(e._modelClassMeta.propertyInitializers),r=0;r<t.length;r++){var i=t[r],s=e._modelClassMeta.propertyInitializers[i];s(e,i)}},p=["$$hashKey","$iid","_modelClassMeta","_collections","_remoteState","_loadingTracker","idAttribute","baseUrl","urlPrefix","$modelErrors","$error","$valid","$invalid","$loading","$selected","$destroyed"];return e.module("angular-modelizer",[]).provider("modelize",function(){var r=this;this.parseModelErrors=function(e){if(!e||!e.fieldErrors||!t.isArray(e.fieldErrors))return null;var r={};return e.fieldErrors.forEach(function(e){var i=e.field,s=e.message;t.isArray(r[i])||(r[i]=[]),r[i].push(s)}),r},this.$get=["$q","$http",function(d,v){var b=function(){if(!(this instanceof b))return new b;var e=this,t=[];this.active=function(){return t.length>0},this.destroy=this.cancel=function(){for(var e=t.length-1;e>=0;e--)t[e].resolve();t.length=0},this.createPromise=function(){var e=d.defer();return t.push(e),e.promise.finally(function(){t.splice(t.indexOf(e),1)}),e},this.addPromise=function(t){if(!t.then)throw new Error("promiseTracker#addPromise expects a promise object!");var r=e.createPromise();return t.then(function(e){return r.resolve(e),e},function(e){return r.reject(e),d.reject(e)}),r}},g={setFuture:function(e,t){return e.$future=t,e}},y=function(e){e=e||{};var r=e.method||"",s=e.url,n=e.data||i,o=!!e.fullResponse,l=d.defer(),a={};return v(t.extend({},e,{method:r.toUpperCase(),url:s,data:n})).then(function(e){a=o?e:e.data,l.resolve(a)},function(e){l.reject(e)}),l.promise=g.setFuture(l.promise,a),l.promise};t.extend(y,{setUrlParams:a.setUrlParams,get:function(e,r){return y(t.extend({},r,{method:"GET",url:e}))},post:function(e,r,i){return y(t.extend({},i,{method:"POST",url:e,data:r}))},put:function(e,r,i){return y(t.extend({},i,{method:"PUT",url:e,data:r}))},patch:function(e,r,i){return y(t.extend({},i,{method:"PATCH",url:e,data:r}))},"delete":function(e,r){return y(t.extend({},r,{method:"DELETE",url:e}))},head:function(e,r){return y(t.extend({},r,{method:"HEAD",url:e}))}});var C,_,U=function(e,r,i,s,n){n=t.clone(n)||{},this.resourceName=e,this.resourceId=r,this.isCollection=i,this.parentModelized=s,this.modelized=f.resolve(this,n),t.extend(this,i?_:C)},x={one:function(e,t,r){return new U(e,t,!1,this.modelized,r)},many:function(e,t){return new U(e,null,!0,this.modelized,t)}},M={get $modelClass(){return this.modelized.modelClass},$new:function(e,r){return e=e||{},!this.isCollection&&this.resourceId&&(e[this.modelized.modelClass.prototype.idAttribute]=this.resourceId),this.modelized.modelClass.$new(e,t.extend({},this.modelized.modelInstanceOptions,r))},$newCollection:function(e,r){return this.modelized.modelClass.$newCollection(e,t.extend({},this.modelized.modelInstanceOptions,r))}};o(U.prototype,x,M),C={get:function(e){return this.$new({},t.extend({},this.modelized.modelInstanceOptions,e)).fetch(e)},save:function(e,r){return this.$new(e,t.extend({},this.modelized.modelInstanceOptions,r)).save(r)},destroy:function(e){return this.$new({},t.extend({},this.modelized.modelInstanceOptions,e)).$destroy(e)}},_={get:function(e,r){return this.modelized.modelClass.get(e,t.extend({},this.modelized.modelInstanceOptions,r))},all:function(e){return this.modelized.modelClass.all(t.extend({},this.modelized.modelInstanceOptions,e))},query:function(e,r){return this.modelized.modelClass.query(e,t.extend({},this.modelized.modelInstanceOptions,r))},create:function(e,r){if(!e&&!t.isObject(e))return d.reject(!1);r=r?t.clone(r):{},e instanceof s||(e=this.modelized.modelClass.$new(e,t.extend({},this.modelized.modelInstanceOptions,r)));var i=e.save(null,r);return g.setFuture(i,e)},destroy:function(e,r){r=r?t.clone(r):{};var i=r.url;return this.modelized.modelClass.baseUrl&&(i=a.setUrlParams(a.appendIdParam(this.modelized.modelClass.baseUrl,e,!0),{})),i||n('URL error: "baseUrl" should be defined on "modelized" model class or "options.url" provided to "destroy" the model'),this.$request.delete(i,r).then(function(){return!0})}};var $=function(e,r){var i=e||{};r=r||{},this.$iid=t.uniqueId("model_"),r.parse&&(i=this.parse(i,r)||{}),i=o({},this._modelClassMeta&&this._modelClassMeta.defaults||{},i),m(this),this.set(i),this._collections={},this._remoteState=null,this.$modelErrors=null,this.baseUrl=r.baseUrl||this.baseUrl||this._class.baseUrl,this.urlPrefix=r.urlPrefix||this.urlPrefix||this._class.urlPrefix,this._loadingTracker=new b,this.initialize.apply(this,arguments),r.initRemoteState&&(this._remoteState=this.serialize())};o($.prototype,{_class:$,get $valid(){return this.isValid()},get $invalid(){return!this.isValid()},get $loading(){return this._loadingTracker&&this._loadingTracker.active()},idAttribute:"id",initialize:function(){},resourceUrl:function(){return this.baseUrl?!this.idAttribute||this.isNew()?a.setUrlParams(a.combineUrls(this.urlPrefix,this.baseUrl),this):a.setUrlParams(a.combineUrls(this.urlPrefix,a.appendIdParam(this.baseUrl,this.idAttribute)),this):null},set:function(e,t){return e=e||{},t=t||{},this._validate(e,t),o(this,e),this},clear:function(e){for(var t in this.getAttributes(e))this[t]=i},fetch:function(e){if(this.$destroyed)return g.setFuture(d.reject(this),this);var r=this,s=this.resourceUrl();e=e?t.clone(e):{},e.parse===i&&(e.parse=!0),s||n('URL error: "baseUrl" should be defined or "options.url" specified to "fetch" the model');var o=this.$request.get(s,e).then(function(t){var i=e.fullResponse?t.data:t,s=e.parse?r.parse(i,e):i;return r.set(s,e),r._remoteState=r.serialize(e),r},function(e){d.reject(e)});return this._loadingTracker&&this._loadingTracker.addPromise(o),g.setFuture(o,this)},save:function(e){if(this.$destroyed)return g.setFuture(d.reject(this),this);e=t.extend({validate:!0},e),e.parse===i&&(e.parse=!0),e.validate!==!1&&(e.validate=!0);var r,s=this,o=this.isNew()?"post":e.patch?"patch":"put";if(e.url)r=e.url;else switch(o){case"post":r=this.baseUrl?a.combineUrls(this.urlPrefix,this.baseUrl):null,r||n('URL error: "baseUrl" should be defined or "options.url" specified to "save:create"');break;case"patch":case"put":r=this.resourceUrl(),r||n('URL error: "baseUrl" should be defined or "options.url" specified to "save:update"')}var l=t.extend({method:o,url:r},e);l.data="patch"===o?this.serialize({changedOnly:!0}):this.serialize(),this.transformOnSave&&t.isFunction(this.transformOnSave)&&(l.data=this.transformOnSave(l.data,e));var u=this.$request(l).then(function(r){if(r&&t.isObject(r)){var i=s.parse(r,e);s.set(i)}return s._remoteState=s.serialize(e),s}).catch(function(e){return 422===e.status&&e.data&&s.parseModelErrors&&(s.clearModelErrors(),s.addModelErrors(s.parseModelErrors(e.data))),d.reject(e)});return this._loadingTracker&&this._loadingTracker.addPromise(u),g.setFuture(u,this)},destroy:function(e){if(this.$destroyed)return g.setFuture(d.reject(this),this);e=e?t.clone(e):{};var r=this,i=function(){if(r._collections)for(var e in r._collections)r._collections[e].remove(r),delete r._collections[e];r._collections=null};if(this.isNew())return e.keepInCollections||i(),d.when(!1);e.wait||e.keepInCollections||i();var s=e.url||this.resourceUrl();s||n('URL error: "baseUrl" should be defined or "options.url" specified to "destroy" the model');var o=this.$request.delete(s,e).then(function(){return e.wait&&!e.keepInCollections&&i(),r.$destroyed=!0,r});return this._loadingTracker&&this._loadingTracker.addPromise(o),g.setFuture(o,this)},getAttributes:function(e){var r=this,i={},s=t.difference(Object.getOwnPropertyNames(r),p);e=e||{};for(var n=0;n<s.length;n++){var o=Object.getOwnPropertyDescriptor(r,s[n]);o&&(o.get&&!o.set&&!e.includeComputed||o.set&&!o.get)||(i[s[n]]=r[s[n]])}return i},serialize:function(e){e=e||{};var t=e.changedOnly?this.getChangedAttributes(e):this.getAttributes(e);for(var r in t){var i=t[r];i&&(i instanceof $||i.$isCollection)&&i.serialize&&(t[r]=i.serialize(e))}return t},toJSON:function(t){return e.toJson(this.serialize(t))},parse:function(e){return e},parseModelErrors:function(e,t){return r.parseModelErrors(e,t)},clone:function(e){return new this.constructor(this.getAttributes(e))},diff:function(e,r){var i={},s=this.getAttributes(r);for(var n in e){var o=e[n],a=s[n]instanceof $,d=s[n].$isCollection,u=!1;if(a){var c=s[n].diff(o);l(c)||(u=!0)}else if(d)if(o&&o.length===s[n].length){for(var h=s[n].serialize(),f=0;f<h.length;f++)if(!t.isEqual(h[f],o[f])){u=!0;break}}else u=!0;else t.isEqual(s[n],o)||(u=!0);u&&(i[n]={currentValue:s[n],comparedValue:o})}return i},getChangedAttributes:function(){var e={};if(this._remoteState){var t=this.diff(this._remoteState);for(var r in t)e[r]=t[r].currentValue}return e},isNew:function(){return!this[this.idAttribute]},isValid:function(e){return this._validate({},t.extend(e||{},{validate:!0}))&&!this.$modelErrors},_validate:function(e,r){return r.validate&&this.validate?(e=t.extend({},this.getAttributes(r),e),this.validationErrors=this.validate(e,r)||null,this.validationErrors?!1:!0):!0},addModelError:function(e,r){if(e&&r&&(t.isString(r)||t.isArray(r))){var i=t.isArray(r)?r:[r];this.$modelErrors||(this.$modelErrors={}),this.$modelErrors[e]&&t.isArray(this.$modelErrors[e])?this.$modelErrors.concat(i):this.$modelErrors[e]=i}},clearModelError:function(e,r){r=r||{},e&&this.$modelErrors[e]&&(r.firstOnly&&t.isArray(this.$modelErrors[e])&&this.$modelErrors[e].length>1?this.$modelErrors[e].shift():delete this.$modelErrors[e])},addModelErrors:function(e){if(e)for(var t in e)this.$modelErrors||(this.$modelErrors={}),this.$modelErrors[t]=e[t]},clearModelErrors:function(){this.$modelErrors=null}});var z={$request:y,get $loading(){return this._loadingTracker&&this._loadingTracker.active()},initialize:function(){},fetch:function(e){var r=this;e=e?t.clone(e):{},e.parse===i&&(e.parse=!0);var s=!!e.fullResponse,n=!!e.rawData,o=e.url;!o&&this.modelClass.baseUrl&&(o=a.combineUrls(this.modelClass.urlPrefix,this.modelClass.baseUrl));var l=this.$request.get(o,e).then(function(t){var i=s?t.data:t,o=e.reset?"reset":"set";return r[o](i,e),n?i:r});return this._loadingTracker&&this._loadingTracker.addPromise(l),g.setFuture(l,this)},get:function(e){if(!e)return i;var t=this._modelId(e);return this._idsIndex[e]||this._idsIndex[t]||this._idsIndex[e.$iid]||i},where:function(e,r){if(t.isEmpty(e))return r?i:[];var s=r?"find":"filter";return t[s](this.models,function(t){for(var r in e)if(e[r]!==t[r])return!1;return!0})},any:function(e){return e?this.where(e).length>0:this.models.length>0},filter:function(e){return t.filter(this.models,e)},create:function(e,r){if(r=r?t.clone(r):{},r.initRemoteState=!0,!(e=this._prepareModel(e,r)))return d.reject(!1);r.wait||this.add(e,r);var i=this,s=e.save(null,r);return s.then(function(){r.wait&&i.add(e,r)}),g.setFuture(s,this)},add:function(e,r){return this.set(e,t.extend({merge:!1},r,{add:!0,remove:!1}))},remove:function(e,r){var i=!t.isArray(e);r=r||{},e=i?[e]:t.clone(e);for(var s=0,n=e.length;n>s;s++){var o=e[s]=this.get(e[s]);if(o){var l=this._modelId(o);null!==l&&delete this._idsIndex[l],delete this._idsIndex[o.$iid];var a=t.indexOf(this.models,o);this.models.splice(a,1),this._removeModelReference(o,r)}}return i?e[0]:e},push:function(e,r){return this.add(e,t.extend({at:this.length},r))},pop:function(e){var t=this.models[this.length-1];return this.remove(t,e),t},unshift:function(e,r){return this.add(e,t.extend({at:0},r))},shift:function(e){var t=this.models[0];return this.remove(t,e),t},slice:function(){return Array.prototype.slice.apply(this.models,arguments)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a collection without a comparator");return e=e||{},t.isString(this.comparator)||1===this.comparator.length?this.models=t.sortBy(this.models,this.comparator,this):this.models.sort.call(this,this.comparator),this},set:function(e,r){if(r=t.defaults({},r,{add:!0,remove:!0,merge:!0}),r.parse&&(e=this.parse(e,r)),r.initRemoteState!==!1&&(r.initRemoteState=!0),!t.isArray(e)&&!t.isObject(e))return e;var i=!t.isArray(e);e=i?e?[e]:[]:e.slice();var s,n,o,l,a,d,u,c,h=r.add,f=r.merge,m=r.remove,p=r.at,v=[],b=[],g={},y=this.comparator&&r.sort!==!1,C=t.isString(this.comparator)?this.comparator:null,_=!y&&h&&m?[]:!1;for(u=0,c=e.length;c>u;u++)if(n=e[u],t.isObject(n)){if(a=this.get(n))m&&(g[a.$iid]=!0),f&&n!==a&&(n=this._isModel(n)?n.getAttributes():n,r.parse&&(n=a.parse(n,r)),a.set(n,r),y&&!s&&(d=a.diff(n),d&&d[C]&&(s=!0))),e[u]=a;else if(h){if(o=e[u]=this._prepareModel(n,r),!o)continue;v.push(o),this._addModelReference(o,r)}o=a||o,o&&(l=this._modelId(o),!_||!o.isNew()&&g[l]||_.push(o),g[l]=!0)}if(m){for(u=0,c=this.models.length;c>u;u++)g[(o=this.models[u]).$iid]||b.push(o);b.length&&this.remove(b,r)}if(v.length||_&&_.length)if(y&&(s=!0),null!==p)for(p||(p=0),u=0,c=v.length;c>u;u++)this.models.splice(p+u,0,v[u]);else{_&&(this.models.length=0);var U=_||v;for(u=0,c=U.length;c>u;u++)this.models.push(U[u])}return s&&this.sort(),i?e[0]:e},reset:function(e,t){t=t||{};for(var r=0,i=this.models.length;i>r;r++)this._removeModelReference(this.models[r],t);return this._reset(),e&&e.length&&this.add(e,t),this},_reset:function(){this.models.length=0,this._idsIndex={}},_prepareModel:function(e,t){if(this._isModel(e))return e;var r=new this.modelClass(e,t);return r},_isModel:function(e){return e instanceof $},_modelId:function(e){return e[this.modelClass.prototype.idAttribute||"id"]},_addModelReference:function(e){if(this._isModel(e)&&e.$iid){this._idsIndex[e.$iid]=e;var t=this._modelId(e);t&&(this._idsIndex[t]=e),e._collections=e._collections||{},e._collections[this.$iid]=this}},_removeModelReference:function(e){if(this._isModel(e)){delete this._idsIndex[e.$iid];var t=this._modelId(e);t&&delete this._idsIndex[t],e._collections&&e._collections[this.$iid]&&delete e._collections[this.$iid]}},serialize:function(e){return t.map(this.models,function(t){return t.serialize(e)})},toJSON:function(t){return e.toJson(this.serialize(t))},parse:function(e){return e},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})}},O=function(e,r){r=r||{};var n=r.modelClass||s,l=[];return o(l,z),n._modelClassMeta&&t.isObject(n._modelClassMeta.collectionExtensions)&&t.extend(l,n._modelClassMeta.collectionExtensions),l.$iid=t.uniqueId("collection_"),l.modelClass=n,l.baseUrl=t.extend({},l.modelClass.baseUrl,r.baseUrl),l.$isCollection=!0,l._loadingTracker=new b,r.comparator!==i&&(l.comparator=r.comparator),l.models=l,l._reset(),l.initialize.apply(l,arguments),e&&l.reset(e,r),l};t.extend($,{extend:function(e,r){t.isObject(e)&&!t.isArray(e)&&(r=e,e=null);var i=h.extendModelClass(this,r,e);return u.addModelClass(i),i},extendCollection:function(e){return h.extendCollection(this,e)},$new:function(e,r){return r=r?t.clone(r):{},new this(e,r)},$newCollection:function(e,r){return r=r?t.clone(r):{},r=t.extend({},{modelClass:this},r),O(e,r)},get:function(e,t){t=t||{};var r=this,i=t.url;if(!i){var s=t.baseUrl||this.baseUrl,o=t.urlPrefix||this.urlPrefix;s&&(i=a.combineUrls(o,a.appendIdParam(s,e,!0)))}i||n('URL error: "baseUrl" should be defined or "options.url" specified to "get" a resource');var l=t.rawData?{}:r.$new({},t),d=this.$request.get(i,t).then(function(e){return t.rawData?l=e:l.set(e,t),l});return g.setFuture(d,l)},query:function(e,t){t=t||{},t.params=e||{};var r=this,i=t.url||a.combineUrls(t.urlPrefix,t.baseUrl)||a.combineUrls(this.urlPrefix,this.baseUrl);i||n('URL error: "baseUrl" should be defined or "options.url" specified to "query" a resource');var s=t.rawData?[]:r.$newCollection([],t),o=this.$request.get(i,t).then(function(e){return t.rawData?s=e:s.reset(e,t),s});return g.setFuture(o,s)},all:function(e){return this.query(null,e)}}),s=$,$.$request=$.prototype.$request=y;var w=function(e,t){return x.many(e,t)};return o(w,x),w.attr=c,w.Model=s,w.$request=y,w.internal={modelizeMetaResolver:f,modelClassCache:u},w.defineModel=function(e,t){return s.extend(e,t)},w}]}).directive("mzModelError",function(){return{restrict:"A",require:["?ngModel"],link:function(t,r,i,s){var n=s[0];n&&i.mzModelError&&t.$watch(i.mzModelError,function(t){var r=t||e.isArray(t)&&t.length>0;n.$setValidity("modelError",!r)})}}})});